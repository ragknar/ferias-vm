<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ferias Valparaíso & Marga Marga</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="css/styles.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="icon" href="icons/icon-192.png" type="image/png" />
</head>
<body>

  <div class="filters">
    <select id="comunaFilter">
      <option value="todas">Todas las comunas</option>
      <option value="Valparaíso">Valparaíso</option>
      <option value="Viña del Mar">Viña del Mar</option>
      <option value="Villa Alemana">Villa Alemana</option>
      <option value="Quilpué">Quilpué</option>
    </select>

    <select id="diaFilter">
      <option value="todos">Todos los días</option>
      <option value="Lunes">Lunes</option>
      <option value="Martes">Martes</option>
      <option value="Miércoles">Miércoles</option>
      <option value="Jueves">Jueves</option>
      <option value="Viernes">Viernes</option>
      <option value="Sábado">Sábado</option>
      <option value="Domingo">Domingo</option>
    </select>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const ferias = [
      {
        nombre: "Feria El Belloto",
        comuna: "Quilpué",
        lat: -33.0425,
        lng: -71.42,
        dias: ["Lunes", "Jueves"],
        horario: "9:00 - 15:00"
      },
      {
        nombre: "Feria Achupallas",
        comuna: "Viña del Mar",
        lat: -33.0301,
        lng: -71.5308,
        dias: ["Miércoles", "Sábado"],
        horario: "8:00 - 14:00"
      },
      {
        nombre: "Feria Villa Alemana Centro",
        comuna: "Villa Alemana",
        lat: -33.0427,
        lng: -71.3729,
        dias: ["Martes", "Viernes"],
        horario: "8:30 - 14:30"
      },
      {
        nombre: "Feria Placilla",
        comuna: "Valparaíso",
        lat: -33.0667,
        lng: -71.6333,
        dias: ["Domingo"],
        horario: "9:00 - 15:00"
      }
    ];

    const map = L.map('map').setView([-33.05, -71.4], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let markers = [];

    function renderFerias() {
      const comuna = document.getElementById('comunaFilter').value;
      const dia = document.getElementById('diaFilter').value;

      markers.forEach(m => map.removeLayer(m));
      markers = [];

      ferias
        .filter(f => (comuna === "todas" || f.comuna === comuna))
        .filter(f => (dia === "todos" || f.dias.includes(dia)))
        .forEach(f => {
          const marker = L.marker([f.lat, f.lng])
            .bindPopup(`<strong>${f.nombre}</strong><br>${f.comuna}<br>Días: ${f.dias.join(", ")}<br>Horario: ${f.horario}`)
            .addTo(map);
          markers.push(marker);
        });
    }

    document.getElementById("comunaFilter").addEventListener("change", renderFerias);
    document.getElementById("diaFilter").addEventListener("change", renderFerias);
    renderFerias();

    map.locate({ setView: false, maxZoom: 14 });
    map.on('locationfound', e => {
      L.marker(e.latlng).addTo(map).bindPopup("Estás aquí").openPopup();
    });

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(reg => console.log('Service Worker registrado', reg))
        .catch(err => console.error('Error al registrar SW:', err));
    }
  </script>

</body>
</html>
